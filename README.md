# Twitch 加班台倒數計時工具

專為 Twitch 實況主設計的加班時間管理工具，使用訂閱者積分系統控制直播延長時間。

## 📦 安裝與啟動

### 方法一：npm 運行（推薦）
```bash
# 安裝依賴
npm install

# 啟動服務器
npm start
# 或者
npm run dev
```

啟動後訪問：
- **控制面板**: http://127.0.0.1:6969/
- **OBS顯示頁面**: http://127.0.0.1:6969/display  
- **Debug工具**: http://127.0.0.1:6969/debug

### 方法二：直接打開文件
直接打開 `index.html` 和 `display.html` 使用

## 功能特色

### 🕐 時間管理
- 手動設定起始倒數時間（小時:分鐘格式）
- 即時倒數計時器，每秒更新
- 暫停/繼續/重置功能
- 時間歸零自動停止並顯示結束狀態

### 💎 積分系統
- **1 積分 = 1 分鐘** 的轉換規則
- 手動輸入積分增加時間
- 快捷按鈕：+1, +5, +10 分鐘
- 今日累計積分統計

### 🎮 Twitch 整合
- **自動積分系統**：訂閱自動轉換為時間（Tier 1/2/3 = 1/3/5 分鐘）
- **匿名連接**：無需複雜的 API 設定，只需頻道名稱
- **防假冒保護**：只監聽 Twitch 系統訊息，排除假冒訂閱
- **即時通知**：顯示獲得的時間獎勵

### 🎥 OBS 整合
- 專用的 OBS 顯示頁面
- 大字體倒數時鐘 (HH:MM:SS)
- 透明背景支援
- 響應式設計，適配各種螢幕尺寸

### 🔊 音效提示
- 積分增加提示音（上升音階）
- 最後 5 分鐘警告音（每分鐘提醒）
- 時間結束提示音（下降音階）

### 💾 數據持久化
- localStorage 自動儲存狀態
- 頁面重新載入後恢復計時器
- 保存今日積分統計和歷史紀錄

## 快速開始

### 1. 啟動服務
```bash
# 運行服務器
npm start
```

### 2. 開啟控制面板
- 訪問 http://127.0.0.1:6969/
- 建議使用 Chrome, Firefox, 或 Edge 瀏覽器

### 3. 基本操作
1. **設定初始時間**：在「時間設定」區域輸入小時和分鐘，點擊「設定時間」
2. **開始計時**：點擊「開始」按鈕開始倒數
3. **增加時間**：輸入積分數量點擊「增加時間」，或使用快捷按鈕
4. **暫停/繼續**：隨時暫停或恢復計時器
5. **重置**：重置回初始設定時間

### 4. Twitch 整合設定（選用）
如需啟用自動訂閱積分功能：
1. **設定積分規則**：在「自動積分規則設定」中調整各層級訂閱的分鐘數
2. **連接聊天室**：輸入您的頻道名稱並點擊「連接聊天室」
3. **開始直播**：系統會自動監聽訂閱事件並按設定增加時間
4. **無需 API Token 或複雜設定！**

#### 層級積分設定
- 可自訂 Tier 1/2/3 訂閱對應的分鐘數（1-60 分鐘）
- 預設值：Tier 1=1分鐘, Tier 2=3分鐘, Tier 3=5分鐘
- 禮物訂閱會按設定的層級積分 × 數量計算
- 設定會自動儲存，頁面重新載入後保持

## OBS 設定教學

### 步驟 1：確保服務器運行
確保已經運行 `npm start` 啟動服務器

### 步驟 2：在 OBS 中新增 Browser Source
1. 在 OBS 中點擊「來源」區域的「+」號
2. 選擇「瀏覽器來源 (Browser Source)」
3. 建立新來源或使用現有來源

### 步驟 3：設定 Browser Source
```
URL: http://127.0.0.1:6969/display
寬度: 1920
高度: 1080
FPS: 30
自訂 CSS: (可選)

☑ 關閉來源時關機
☑ 重新整理瀏覽器當場景啟用時
```

**💡 提示**: 也可以在控制面板的「OBS 顯示」區域點擊「複製連結」按鈕

### 步驟 4：調整顯示效果
- 調整來源大小和位置
- 可以搭配濾鏡效果
- 建議放在畫面右上角或下方明顯位置

## 🔧 Debug 工具

訪問 http://127.0.0.1:6969/debug 可以：
- 查看localStorage數據狀態
- 清除所有數據重置
- 設定測試計時器
- 檢查數據同步問題

在display頁面按 **D** 鍵可顯示即時debug資訊。

## 文件結構

```
twitch-overtime-timer/
├── server.js           # Express 服務器
├── package.json        # npm 配置和依賴
├── index.html          # 主控制頁面
├── display.html        # OBS 顯示頁面
├── debug.html          # Debug 工具頁面
├── css/
│   ├── main.css        # 控制面板樣式
│   └── display.css     # 顯示器樣式
├── js/
│   ├── timer.js        # 核心計時邏輯
│   ├── storage.js      # 資料儲存管理
│   ├── audio.js        # 音效管理
│   └── twitch-chat.js  # Twitch 聊天室監聽
└── README.md           # 說明文件
```

## 進階功能

### Twitch 自動積分規則
系統會自動監聽以下 Twitch 事件：

| 事件類型 | 預設時間 | 說明 |
|----------|----------|------|
| Tier 1 訂閱 | +1 分鐘 | 新訂閱或續訂（可自訂 1-60 分鐘） |
| Tier 2 訂閱 | +3 分鐘 | 新訂閱或續訂（可自訂 1-60 分鐘） |
| Tier 3 訂閱 | +5 分鐘 | 新訂閱或續訂（可自訂 1-60 分鐘） |
| 禮物訂閱 | 按層級×數量 | 批量禮物自動計算 |

**💡 提示**：您可以在「自動積分規則設定」中調整各層級對應的分鐘數！

### 防假冒機制
- ✅ 只監聽 `USERNOTICE` 系統訊息
- ✅ 驗證必要的系統標籤
- ✅ 忽略普通聊天訊息
- ✅ 自動排除假冒訂閱文字

### 音效控制
音效功能會在用戶第一次點擊頁面後自動啟用，包含：
- **積分增加音**：正面的上升音階
- **警告音**：最後 5 分鐘每分鐘提醒
- **結束音**：時間到的下降音階

### 數據統計
在「今日統計」面板中可以查看：
- 總積分數：當日累計獲得的積分
- 總時長：當日累計增加的時間

### 瀏覽器兼容性
- ✅ Chrome 60+
- ✅ Firefox 55+
- ✅ Edge 79+
- ✅ Safari 12+

## 常見問題

### Q: OBS顯示00:00:00但瀏覽器正常？
A: **已修復！**這是OBS Browser Source localStorage隔離問題，新版本使用服務器同步：
1. 確保運行 `npm start` 
2. URL使用：`http://127.0.0.1:6969/display`
3. 刷新OBS Browser Source
4. 查看完整解決方案：`obs-troubleshooting.md`

### Q: 為什麼時間一直顯示 0:00:00？
A: 請確保：
1. 服務器正在運行（`npm start`）
2. 在控制面板中設定了初始時間
3. 點擊了「開始」按鈕
4. 使用debug工具檢查數據狀態

### Q: OBS顯示異常？
A: 請確保：
1. OBS Browser Source URL是 `http://127.0.0.1:6969/display`
2. 服務器正在運行
3. 清除OBS快取並重新添加來源

### Q: 啟動失敗？
A: 請檢查：
1. Node.js是否已安裝
2. 運行 `npm install` 安裝依賴
3. 端口6969是否被占用

### Q: 如何設定 Twitch 整合？
A: 只需輸入您的頻道名稱（如：shroud）然後點擊「連接聊天室」即可，無需 API Token。

### Q: 如何自訂訂閱積分？
A: 在「自動積分規則設定」中調整 Tier 1/2/3 對應的分鐘數（1-60 分鐘），點擊「儲存設定」即可。

### Q: 會監聽到假冒的訂閱訊息嗎？
A: 不會，系統只監聽 Twitch 官方的系統訊息（USERNOTICE），會自動排除普通用戶的假冒文字。

### Q: 層級設定會保存嗎？
A: 是的，設定會自動儲存到 localStorage，頁面重新載入後仍會保持您的自訂設定。

### Q: Twitch 連接失敗怎麼辦？
A: 檢查頻道名稱是否正確（小寫，不包含 # 符號），確認網路連接正常。

### Q: 頁面重新載入後計時器會重置嗎？
A: 不會，所有狀態都會自動保存在 localStorage 中，重新載入後會恢復之前的狀態。

### Q: OBS 中顯示的時間不同步怎麼辦？
A: 重新整理 OBS 的 Browser Source，或檢查 URL 是否正確。

### Q: 音效沒有聲音？
A: 瀏覽器需要用戶互動才能播放音效，請先點擊頁面任意位置啟用音效功能。

### Q: 支援手機瀏覽嗎？
A: 支援，介面採用響應式設計，可在手機上正常使用。

## 技術規格

- **後端**: Node.js + Express.js
- **前端技術**: HTML5, CSS3, Vanilla JavaScript
- **存儲方案**: localStorage
- **音效**: Web Audio API
- **Twitch 整合**: 匿名 IRC 連接（無需 API Token）
- **兼容性**: 現代瀏覽器 (ES6+)

## 更新紀錄

### v3.3.0 (背景標籤節流問題修復版本)
- 🎯 **修復背景標籤節流問題**：解決控制頁面關閉/背景化時計時器變慢問題
- ⏱️ **絕對時間計算系統**：基於時間戳而非setInterval累計，完全避免瀏覽器節流
- 🚀 **性能持續優化**：保持智能同步，避免不必要的HTTP請求和localStorage寫入
- 🔄 **智能時間更新**：addTime()方法正確處理絕對時間，確保時間增減準確
- ✨ **穩定性提升**：計時器在任何瀏覽器狀態下都保持精確1秒間隔

### v3.2.0 (積分減少與Bits功能版本)
- ➖ **積分減少功能**：新增-1/-5/-10分鐘快捷按鈕
- 🎁 **Twitch Bits自動監聽**：支持觀眾透過Bits增加直播時間
- ⚙️ **Bits設定系統**：可自訂每Bits兌換率、最小數量、最大時間
- 🔊 **自動檢測**：即時監聽Bits事件，無需手動操作
- 🎨 **UI改進**：橘色Bits主題，綠色增加/紅色減少按鈕區分

### v3.1.0 (OBS同步問題修復版本)
- 🔧 **修復OBS Browser Source同步問題**：徹底解決顯示00:00:00的問題
- 🌐 **服務器端狀態同步**：新增 `/api/timer` API端點
- 🔄 **智能回退機制**：服務器優先，localStorage備用
- 📋 **OBS故障排除指南**：完整的troubleshooting文檔
- ✅ **自動同步**：控制面板與OBS實時同步狀態

### v3.0.0 (npm技術棧版本)
- 🚀 **改為npm技術棧**，使用Express.js服務器
- 🌐 **HTTP服務器**：http://127.0.0.1:6969
- 🔧 **新增debug工具頁面**：完整的數據管理和測試工具
- 📝 **改善URL管理**：自動識別HTTP和文件模式
- 🛠️ **npm scripts**：`npm start`, `npm run dev`
- ✅ 保持所有原有功能完整兼容

### v2.1.0 (可自訂層級版本)
- ✅ 基本倒數計時功能
- ✅ 積分轉換系統 (1積分=1分鐘)
- ✅ OBS 顯示頁面
- ✅ **簡化 Twitch 整合**（只需頻道名稱）
- ✅ **可自訂訂閱積分**（Tier 1/2/3 可設定 1-60 分鐘）
- ✅ **自動訂閱檢測**（預設 Tier 1/2/3 = 1/3/5 分鐘）
- ✅ **防假冒保護**（只監聽系統訊息）
- ✅ **設定持久化**（層級設定自動保存）
- ✅ 音效提示系統
- ✅ 數據持久化
- ✅ 今日統計功能
- ✅ 快捷按鈕
- ✅ 響應式設計

## 授權條款

MIT License - 可自由使用、修改和分發。

## 支援與回饋

如有問題或建議，歡迎透過以下方式聯絡：
- GitHub Issues
- 或直接修改代碼提交 Pull Request

---

**祝直播愉快！** 🎮✨