<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€’æ•¸è¨ˆæ™‚é¡¯ç¤º - OBSç”¨</title>
    <link rel="stylesheet" href="css/display.css">
</head>
<body>
    <div class="timer-display">
        <div id="countdown">00:00:00</div>
        <div id="status"></div>
        <div id="debug" style="position: absolute; top: 10px; left: 10px; color: white; font-size: 12px; background: rgba(0,0,0,0.7); padding: 5px; display: none;"></div>
    </div>

    <script src="js/storage.js"></script>
    <script>
        // OBSé¡¯ç¤ºé é¢ - æœå‹™å™¨åŒæ­¥ç‰ˆæœ¬
        let timerInterval;
        let useServerAPI = false;
        
        // æª¢æŸ¥æ˜¯å¦å¯ä»¥ä½¿ç”¨æœå‹™å™¨API
        async function checkServerAPI() {
            try {
                const response = await fetch('/api/timer');
                if (response.ok) {
                    useServerAPI = true;
                    console.log('âœ… ä½¿ç”¨æœå‹™å™¨APIæ¨¡å¼ï¼ˆè§£æ±ºOBSåŒæ­¥å•é¡Œï¼‰');
                } else {
                    console.log('ğŸ“‚ ä½¿ç”¨localStorageæ¨¡å¼');
                }
            } catch (error) {
                console.log('ğŸ“‚ ä½¿ç”¨localStorageæ¨¡å¼');
            }
        }
        
        // å¾æœå‹™å™¨ç²å–è¨ˆæ™‚å™¨æ•¸æ“š
        async function getTimerDataFromServer() {
            try {
                const response = await fetch('/api/timer');
                if (response.ok) {
                    const data = await response.json();
                    return {
                        remainingTime: data.actualRemainingTime, // æœå‹™å™¨å·²è¨ˆç®—å¥½çš„å¯¦éš›å‰©é¤˜æ™‚é–“
                        isRunning: data.isRunning,
                        startTime: data.startTime,
                        initialTime: data.initialTime,
                        absoluteEndTime: data.absoluteEndTime,
                        absoluteStartTime: data.absoluteStartTime
                    };
                }
            } catch (error) {
                console.log('âš ï¸ æœå‹™å™¨è«‹æ±‚å¤±æ•—ï¼Œå›é€€åˆ°localStorage');
            }
            
            // å›é€€åˆ°localStorage
            return Storage.getTimerData();
        }
        
        async function updateDisplay() {
            const timerData = useServerAPI ? 
                await getTimerDataFromServer() : 
                Storage.getTimerData();
            const countdownEl = document.getElementById('countdown');
            const statusEl = document.getElementById('status');
            const debugEl = document.getElementById('debug');
            
            let displayTime;
            let isTimeUp = false;
            
            if (useServerAPI) {
                // æœå‹™å™¨APIæ¨¡å¼ï¼šä½¿ç”¨æœå‹™å™¨è¨ˆç®—å¥½çš„actualRemainingTime
                displayTime = timerData.remainingTime; // é€™å¯¦éš›ä¸Šæ˜¯ actualRemainingTime
                isTimeUp = (displayTime === 0 && timerData.initialTime > 0);
            } else {
                // localStorageæ¨¡å¼ï¼šéœ€è¦åœ¨å®¢æˆ¶ç«¯è¨ˆç®—
                if (timerData.isRunning && timerData.remainingTime > 0) {
                    // å„ªå…ˆä½¿ç”¨çµ•å°æ™‚é–“è¨ˆç®—
                    if (timerData.absoluteEndTime) {
                        const currentTime = Date.now();
                        displayTime = Math.max(0, timerData.absoluteEndTime - Math.floor(currentTime / 1000));
                    } else {
                        // å›é€€åˆ°èˆŠé‚è¼¯
                        const currentTime = Date.now();
                        const elapsed = Math.floor((currentTime - timerData.startTime) / 1000);
                        displayTime = Math.max(0, timerData.remainingTime - elapsed);
                    }
                    
                    if (displayTime === 0) {
                        isTimeUp = true;
                    }
                } else {
                    displayTime = timerData.remainingTime;
                    isTimeUp = (displayTime === 0 && timerData.initialTime > 0);
                }
            }
            
            // Debug è³‡è¨Š
            debugEl.innerHTML = `
                å‰©é¤˜: ${timerData.remainingTime}s<br>
                åˆå§‹: ${timerData.initialTime}s<br>
                é‹è¡Œ: ${timerData.isRunning}<br>
                é¡¯ç¤º: ${displayTime}s<br>
                æ™‚é–“åˆ°: ${isTimeUp}
            `;
            
            const hours = Math.floor(displayTime / 3600);
            const minutes = Math.floor((displayTime % 3600) / 60);
            const seconds = displayTime % 60;
            
            countdownEl.textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // æ¸…é™¤æ‰€æœ‰æ¨£å¼
            countdownEl.classList.remove('warning', 'finished');
            statusEl.textContent = '';
            
            if (isTimeUp) {
                // æ™‚é–“åˆ°
                statusEl.textContent = 'æ™‚é–“åˆ°ï¼';
                countdownEl.classList.add('finished');
            } else if (displayTime <= 300 && displayTime > 0) {
                // æœ€å¾Œ5åˆ†é˜è­¦å‘Š
                countdownEl.classList.add('warning');
            } else if (!timerData.isRunning && displayTime > 0) {
                // æš«åœä¸­
                statusEl.textContent = 'æš«åœä¸­';
            }
        }
        
        // æŒ‰ä¸‹ D éµé¡¯ç¤º/éš±è— debug è³‡è¨Š
        document.addEventListener('keydown', function(e) {
            if (e.key === 'd' || e.key === 'D') {
                const debugEl = document.getElementById('debug');
                debugEl.style.display = debugEl.style.display === 'none' ? 'block' : 'none';
            }
        });
        
        // åˆå§‹åŒ–
        async function init() {
            await checkServerAPI();
            await updateDisplay();
            
            // åŒæ­¥åˆ°æ•´ç§’é‚Šç•Œï¼Œç¢ºä¿èˆ‡æ§åˆ¶é é¢ä¸€è‡´
            const now = Date.now();
            const msUntilNextSecond = 1000 - (now % 1000);
            
            setTimeout(() => {
                // åœ¨æ•´ç§’é‚Šç•Œå•Ÿå‹•å®šæ™‚å™¨
                updateDisplay();
                setInterval(updateDisplay, 1000);
            }, msUntilNextSecond);
        }
        
        // å•Ÿå‹•
        init();
    </script>
</body>
</html>