<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>倒數計時顯示 - OBS用</title>
    <link rel="stylesheet" href="css/display.css">
</head>
<body>
    <div class="timer-display">
        <div id="countdown">00:00:00</div>
        <div id="status"></div>
        <div id="debug" style="position: absolute; top: 10px; left: 10px; color: white; font-size: 12px; background: rgba(0,0,0,0.7); padding: 5px; display: none;"></div>
    </div>

    <script src="js/storage.js"></script>
    <script>
        // OBS顯示頁面 - 服務器同步版本
        let timerInterval;
        let useServerAPI = false;
        
        // 檢查是否可以使用服務器API
        async function checkServerAPI() {
            try {
                const response = await fetch('/api/timer');
                if (response.ok) {
                    useServerAPI = true;
                    console.log('✅ 使用服務器API模式（解決OBS同步問題）');
                } else {
                    console.log('📂 使用localStorage模式');
                }
            } catch (error) {
                console.log('📂 使用localStorage模式');
            }
        }
        
        // 從服務器獲取計時器數據
        async function getTimerDataFromServer() {
            try {
                const response = await fetch('/api/timer');
                if (response.ok) {
                    const data = await response.json();
                    return {
                        remainingTime: data.actualRemainingTime,
                        isRunning: data.isRunning,
                        startTime: data.startTime,
                        initialTime: data.initialTime
                    };
                }
            } catch (error) {
                console.log('⚠️ 服務器請求失敗，回退到localStorage');
            }
            
            // 回退到localStorage
            return Storage.getTimerData();
        }
        
        async function updateDisplay() {
            const timerData = useServerAPI ? 
                await getTimerDataFromServer() : 
                Storage.getTimerData();
            const countdownEl = document.getElementById('countdown');
            const statusEl = document.getElementById('status');
            const debugEl = document.getElementById('debug');
            
            let displayTime;
            let isTimeUp = false;
            
            if (timerData.isRunning && timerData.remainingTime > 0) {
                const currentTime = Date.now();
                const elapsed = Math.floor((currentTime - timerData.startTime) / 1000);
                displayTime = Math.max(0, timerData.remainingTime - elapsed);
                
                if (displayTime === 0) {
                    isTimeUp = true;
                }
            } else {
                displayTime = timerData.remainingTime;
                // 只有當初始時間大於0且當前剩餘時間為0時才算時間到
                isTimeUp = (displayTime === 0 && timerData.initialTime > 0);
            }
            
            // Debug 資訊
            debugEl.innerHTML = `
                剩餘: ${timerData.remainingTime}s<br>
                初始: ${timerData.initialTime}s<br>
                運行: ${timerData.isRunning}<br>
                顯示: ${displayTime}s<br>
                時間到: ${isTimeUp}
            `;
            
            const hours = Math.floor(displayTime / 3600);
            const minutes = Math.floor((displayTime % 3600) / 60);
            const seconds = displayTime % 60;
            
            countdownEl.textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // 清除所有樣式
            countdownEl.classList.remove('warning', 'finished');
            statusEl.textContent = '';
            
            if (isTimeUp) {
                // 時間到
                statusEl.textContent = '時間到！';
                countdownEl.classList.add('finished');
            } else if (displayTime <= 300 && displayTime > 0) {
                // 最後5分鐘警告
                countdownEl.classList.add('warning');
            } else if (!timerData.isRunning && displayTime > 0) {
                // 暫停中
                statusEl.textContent = '暫停中';
            }
        }
        
        // 按下 D 鍵顯示/隱藏 debug 資訊
        document.addEventListener('keydown', function(e) {
            if (e.key === 'd' || e.key === 'D') {
                const debugEl = document.getElementById('debug');
                debugEl.style.display = debugEl.style.display === 'none' ? 'block' : 'none';
            }
        });
        
        // 初始化
        async function init() {
            await checkServerAPI();
            await updateDisplay();
            
            // 每秒更新一次
            setInterval(updateDisplay, 1000);
        }
        
        // 啟動
        init();
    </script>
</body>
</html>